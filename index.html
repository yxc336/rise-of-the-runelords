<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¦æ–‡é¢†ä¸»çš„å´›èµ· - NPC åŠ¨æ€æ¡£æ¡ˆåº“</title>
    <style>
        :root {
            --pf-æ·±çº¢: #8b0000;
            --pf-å¤é‡‘: #b8860b;
            --pf-çº¸å¼ : #f4ece1;
            --pf-è¾¹æ¡†: #3d2b1f;
            --pf-æ–‡æœ¬: #2c241e;
            --pf-è­¦å‘Šçº¢: #ff3333;
        }

        /* === åŠ¨ç”»å®šä¹‰ === */
        @keyframes çº¸å¼ å±•å¼€ {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes å‘¼å¸å…‰ {
            0% { box-shadow: 0 0 50px rgba(0,0,0,0.8); }
            50% { box-shadow: 0 0 70px rgba(184, 134, 11, 0.2); }
            100% { box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        }

        @keyframes å¼¹çª—è¿›å…¥ {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        /* ç´§æ€¥æœªä¿å­˜åŠ¨ç”» */
        @keyframes ç´§æ€¥å‘¼å¸ {
            0% { transform: scale(1); box-shadow: 0 0 5px var(--pf-è­¦å‘Šçº¢); }
            50% { transform: scale(1.05); box-shadow: 0 0 20px var(--pf-è­¦å‘Šçº¢), 0 0 10px #fff; }
            100% { transform: scale(1); box-shadow: 0 0 5px var(--pf-è­¦å‘Šçº¢); }
        }

        @keyframes èƒŒæ™¯æš—æµ {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes å°˜åŸƒæ¼‚æµ® {
            0% { transform: translateY(100vh) translateX(0) rotate(0deg); opacity: 0; }
            20% { opacity: 0.6; }
            80% { opacity: 0.4; }
            100% { transform: translateY(-10vh) translateX(20px) rotate(180deg); opacity: 0; }
        }

        body {
            background-color: #111;
            background-image: 
                url('https://www.transparenttextures.com/patterns/dark-leather.png'),
                radial-gradient(circle at 50% 50%, rgba(139, 0, 0, 0.15), rgba(0, 0, 0, 0.8));
            background-attachment: fixed, fixed;
            background-size: auto, 200% 200%;
            animation: èƒŒæ™¯æš—æµ 15s ease infinite;
            color: var(--pf-æ–‡æœ¬);
            font-family: "Source Han Serif SC", "Songti SC", serif;
            margin: 0; padding: 30px 10px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        #ç‰¹æ•ˆå±‚ {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; pointer-events: none; overflow: hidden;
        }

        .å¥¥æœ¯å°˜åŸƒ {
            position: absolute;
            background: var(--pf-å¤é‡‘);
            border-radius: 50%;
            box-shadow: 0 0 4px var(--pf-å¤é‡‘);
        }

        .æ¡£æ¡ˆå®¹å™¨ {
            width: 100%; max-width: 1250px;
            background-color: var(--pf-çº¸å¼ );
            background-image: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(210,180,140,0.1) 100%);
            border: 10px solid var(--pf-è¾¹æ¡†);
            border-image: url('https://www.transparenttextures.com/patterns/dark-leather.png') 30 round;
            padding: 30px;
            position: relative;
            animation: å‘¼å¸å…‰ 4s infinite ease-in-out, çº¸å¼ å±•å¼€ 0.8s ease-out;
            z-index: 1;
        }

        header {
            text-align: center;
            border-bottom: 3px double var(--pf-æ·±çº¢);
            margin-bottom: 25px; padding-bottom: 15px;
            transition: border-color 0.5s;
        }
        header:hover { border-bottom-color: var(--pf-å¤é‡‘); }

        h1 { 
            color: var(--pf-æ·±çº¢); font-size: 2.6em; margin: 0; letter-spacing: 0.2em; 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        .å‰¯æ ‡é¢˜ { color: var(--pf-å¤é‡‘); font-size: 1.1em; font-weight: bold; margin-top: 5px; letter-spacing: 0.4em; }

        #çŠ¶æ€æ  { 
            font-size: 0.85em; color: var(--pf-æ·±çº¢); margin-bottom: 15px; 
            text-align: center; font-style: italic; height: 1.2em;
            transition: opacity 0.3s;
        }

        .æ§åˆ¶å° { 
            margin-bottom: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; 
            position: sticky; top: 0; z-index: 100; background: inherit; padding: 10px 0;
            backdrop-filter: blur(2px); align-items: center;
        }

        .æŒ‰é’® {
            background: var(--pf-æ·±çº¢); color: white; border: 2px solid var(--pf-å¤é‡‘);
            padding: 8px 16px; cursor: pointer; font-weight: bold; 
            display: flex; align-items: center; gap: 5px;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .æŒ‰é’®:hover { 
            background: var(--pf-å¤é‡‘); color: var(--pf-æ·±çº¢); 
            transform: translateY(-2px); box-shadow: 0 5px 10px rgba(0,0,0,0.4);
        }
        .æŒ‰é’®:active { transform: translateY(0); box-shadow: 0 2px 3px rgba(0,0,0,0.3); }

        .åŒæ­¥æŒ‰é’® { background: #2e4d2e; border-color: #4CAF50; }
        .åŒæ­¥æŒ‰é’®:hover { background: #4CAF50; color: white; }
        
        /* æœªä¿å­˜è­¦å‘Šæ ·å¼ */
        .æŒ‰é’®-æœªä¿å­˜ {
            background: #800000 !important;
            border-color: var(--pf-è­¦å‘Šçº¢) !important;
            color: var(--pf-è­¦å‘Šçº¢) !important;
            animation: ç´§æ€¥å‘¼å¸ 1.5s infinite ease-in-out !important;
        }
        .æŒ‰é’®-æœªä¿å­˜:hover { color: #fff !important; }

        /* æ¨¡å¼åˆ‡æ¢æŒ‰é’®æ ·å¼ */
        .æŒ‰é’®-æ¨¡å¼ { background: #333; border-color: #666; color: #aaa; }
        body.ç¼–è¾‘æ¨¡å¼ .æŒ‰é’®-æ¨¡å¼ { background: var(--pf-æ·±çº¢); border-color: var(--pf-å¤é‡‘); color: white; }

        /* åˆ†éš”çº¿ */
        .åˆ†éš”ç¬¦ { width: 1px; height: 30px; background: rgba(0,0,0,0.1); margin: 0 5px; border-right: 1px solid rgba(255,255,255,0.3); }

        /* ç®¡ç†å‘˜æ§ä»¶ç»„ - é»˜è®¤éšè— */
        .ç®¡ç†å‘˜ç»„ { display: none; gap: 10px; align-items: center; }
        body.ç¼–è¾‘æ¨¡å¼ .ç®¡ç†å‘˜ç»„ { display: flex; }

        .è¡¨æ ¼åŒ…è£…å±‚ { overflow-x: auto; border: 1px solid var(--pf-è¾¹æ¡†); box-shadow: inset 0 0 20px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; background-color: rgba(255,255,255,0.2); }
        thead { background-color: var(--pf-æ·±çº¢); color: white; }
        th { padding: 12px; text-align: left; border: 1px solid var(--pf-è¾¹æ¡†); font-size: 0.9em; }
        td { 
            padding: 10px; border: 1px solid #c4a484; vertical-align: middle; font-size: 0.85em; 
            transition: background-color 0.3s;
        }

        tr:hover td { background-color: rgba(184, 134, 11, 0.1); }
        .è¡Œè¿›å…¥ { animation: çº¸å¼ å±•å¼€ 0.5s ease-out backwards; }

        .ç«‹ç»˜æ¡† { 
            width: 65px; height: 80px; border: 2px solid var(--pf-å¤é‡‘); 
            overflow: hidden; cursor: zoom-in; margin: 0 auto; 
            position: relative; background: #000;
            transition: transform 0.3s, box-shadow 0.3s, border-color 0.3s;
        }
        .ç«‹ç»˜æ¡†:hover { transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.5); border-color: var(--pf-æ·±çº¢); z-index: 10; }
        .ç«‹ç»˜æ¡† img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
        .ç«‹ç»˜æ¡†:hover img { transform: scale(1.1); }
        
        .å§“åæ ¼ { font-weight: bold; color: var(--pf-æ·±çº¢); }
        
        /* ä»…åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹æ˜¾ç¤ºå¯ç¼–è¾‘æ ·å¼ */
        body.ç¼–è¾‘æ¨¡å¼ [contenteditable="true"]:hover { background: rgba(255,255,255,0.5); cursor: text; }
        body.ç¼–è¾‘æ¨¡å¼ [contenteditable="true"]:focus { 
            background: white; outline: none;
            box-shadow: 0 0 0 2px var(--pf-å¤é‡‘), 0 0 10px rgba(184, 134, 11, 0.3); color: #000;
        }

        /* ç®¡ç†åˆ—æ˜¾éš */
        .ç®¡ç†åˆ— { display: none; }
        body.ç¼–è¾‘æ¨¡å¼ .ç®¡ç†åˆ— { display: table-cell; }

        .ç®¡ç†æ ¼ { display: flex; flex-direction: column; gap: 5px; align-items: center; }
        .æ“ä½œç»„ { display: flex; gap: 5px; width: 100%; justify-content: center; }

        .æ’åºæ§ä»¶ { display: flex; gap: 3px; }
        .å°æ–¹é’® { 
            padding: 2px 6px; cursor: pointer; background: var(--pf-æ·±çº¢); 
            color: white; border: 1px solid var(--pf-å¤é‡‘); font-size: 10px; transition: 0.2s;
        }
        .å°æ–¹é’®:hover { background: var(--pf-å¤é‡‘); }

        .å¼¹çª—é®ç½© {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center;
            backdrop-filter: blur(5px); transition: opacity 0.3s;
        }

        .ä¸Šä¼ é¢æ¿ {
            background: var(--pf-çº¸å¼ ); border: 2px solid var(--pf-å¤é‡‘);
            padding: 30px; width: 400px; text-align: center;
            box-shadow: 0 0 50px rgba(0,0,0,1);
            animation: å¼¹çª—è¿›å…¥ 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .ä¸Šä¼ é¢æ¿ h3 { color: var(--pf-æ·±çº¢); margin-top: 0; font-family: inherit; }
        .ä¸Šä¼ åŒºåŸŸ {
            border: 2px dashed var(--pf-å¤é‡‘); padding: 20px; margin: 15px 0;
            color: var(--pf-æ·±çº¢); font-size: 0.9em; background: rgba(255,255,255,0.4);
            transition: background 0.3s;
        }
        .ä¸Šä¼ åŒºåŸŸ:hover { background: rgba(255,255,255,0.8); }

        .ç½‘å€è¾“å…¥ {
            width: 90%; padding: 8px; background: #fff; border: 1px solid var(--pf-è¾¹æ¡†);
            color: #333; margin-bottom: 10px; font-family: inherit; transition: box-shadow 0.3s;
        }
        .ç½‘å€è¾“å…¥:focus { box-shadow: 0 0 8px var(--pf-å¤é‡‘); outline: none; }

        #æ”¾å¤§é¢„è§ˆ { cursor: zoom-out; }
        #æ”¾å¤§é¢„è§ˆ img { 
            max-width: 85%; max-height: 85%; border: 4px solid var(--pf-å¤é‡‘); 
            box-shadow: 0 0 40px #000; animation: å¼¹çª—è¿›å…¥ 0.3s ease-out;
        }

        .ç‘Ÿå¸Œéš†ç¬¦å· { 
            text-align: center; margin-top: 30px; color: var(--pf-å¤é‡‘); 
            font-size: 1.2em; opacity: 0.4; letter-spacing: 10px; transition: opacity 0.5s;
        }
        .ç‘Ÿå¸Œéš†ç¬¦å·:hover { opacity: 1; text-shadow: 0 0 10px var(--pf-å¤é‡‘); }
    </style>
</head>
<body>

    <div id="ç‰¹æ•ˆå±‚"></div>

    <div class="æ¡£æ¡ˆå®¹å™¨">
        <header>
            <h1>ç¬¦æ–‡é¢†ä¸»çš„å´›èµ·</h1>
            <div class="å‰¯æ ‡é¢˜">ç“¦ç‘è¥¿äºšé‡è¦äººç‰©å¿—</div>
        </header>

        <div id="çŠ¶æ€æ ">æ„¿é˜¿å·´è¾¾å°”æŒ‡å¼•ä½ ã€‚</div>

        <div class="æ§åˆ¶å°">
            <!-- æ‰€æœ‰äººå¯è§ -->
            <!-- ä¿®å¤ç‚¹ï¼šåˆå§‹çŠ¶æ€æ˜¯è§‚å¯Ÿæ¨¡å¼ï¼Œæ‰€ä»¥æŒ‰é’®æ˜¾ç¤ºâ€œâœ ç¼–è¾‘æ¨¡å¼â€ï¼Œæç¤ºå»ç‚¹å‡»ç¼–è¾‘ -->
            <button class="æŒ‰é’® æŒ‰é’®-æ¨¡å¼" onclick="åˆ‡æ¢æ¨¡å¼()" id="æ¨¡å¼æŒ‰é’®">âœ ç¼–è¾‘æ¨¡å¼</button>
            <button class="æŒ‰é’®" onclick="åŠ è½½æ•°æ®()">ğŸ”„ åˆ·æ–°é‡è½½</button>
            <button class="æŒ‰é’®" style="background:#4a3728" onclick="å¯¼å‡ºå¤‡ä»½()">å¯¼å‡º</button>

            <!-- ä»…ç¼–è¾‘æ¨¡å¼å¯è§ -->
            <div class="ç®¡ç†å‘˜ç»„">
                <div class="åˆ†éš”ç¬¦"></div>
                <button class="æŒ‰é’®" onclick="æ·»åŠ è¡Œ()">+ æ–°å¢ NPC</button>
                <button class="æŒ‰é’® åŒæ­¥æŒ‰é’®" id="ä¿å­˜æŒ‰é’®" onclick="ä¿å­˜åˆ°äº‘ç«¯()">â— ç¥­ä»ªä¿å­˜ (åŒæ­¥)</button>
                <button class="æŒ‰é’®" style="background:#4a3728" onclick="è§¦å‘å¯¼å…¥()">å¯¼å…¥</button>
            </div>
            
            <input type="file" id="å¯¼å…¥æ¡†" style="display:none" accept=".json" onchange="å¯¼å…¥å¤‡ä»½(event)">
        </div>

        <div class="è¡¨æ ¼åŒ…è£…å±‚">
            <table>
                <thead>
                    <tr>
                        <th width="80">ç«‹ç»˜</th>
                        <th width="150">å§“å</th>
                        <th width="160">èº«ä»½/èŒä½</th>
                        <th width="200">ç›®æ ‡/åŠ¨æœº</th>
                        <th>å¤‡æ³¨ä¸è®°å½•</th>
                        <th width="120" class="ç®¡ç†åˆ—">æ¡£æ¡ˆç®¡ç†</th>
                    </tr>
                </thead>
                <tbody id="è¡¨æ ¼ä¸»ä½“"></tbody>
            </table>
        </div>
        <div id="é¡µå°¾é”šç‚¹"></div>
        <div class="ç‘Ÿå¸Œéš†ç¬¦å·">â˜… â˜… â˜… â˜… â˜… â˜… â˜…</div>
    </div>

    <div id="æ”¾å¤§é¢„è§ˆ" class="å¼¹çª—é®ç½©" onclick="this.style.display='none'">
        <img id="é¢„è§ˆå›¾" src="">
    </div>

    <div id="æ›´å›¾å¼¹çª—" class="å¼¹çª—é®ç½©">
        <div class="ä¸Šä¼ é¢æ¿">
            <h3>é•œåƒå¹»å½±æ›´æ›¿</h3>
            <p style="font-size: 0.8em; color: #5d4037;">ç›´æ¥åœ¨è¿™é‡Œ Ctrl+V ç²˜è´´å›¾ç‰‡<br>æˆ–ä½¿ç”¨ä¸‹æ–¹é€‰é¡¹</p>
            <div class="ä¸Šä¼ åŒºåŸŸ">
                <button class="æŒ‰é’®" style="font-size: 0.8em; margin: 0 auto;" onclick="document.getElementById('éšè—ä¸Šä¼ ').click()">é€‰æ‹©æœ¬åœ°æ–‡ä»¶</button>
            </div>
            <input type="text" id="ç½‘å€è¾“å…¥æ¡†" class="ç½‘å€è¾“å…¥" placeholder="æˆ–åœ¨æ­¤è¾“å…¥å›¾ç‰‡é“¾æ¥...">
            <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                <button class="æŒ‰é’®" onclick="ç¡®å®šç½‘å€()">ç¡®å®šé“¾æ¥</button>
                <button class="æŒ‰é’®" style="border-color:#555; background:#666;" onclick="å…³é—­æ›´å›¾å¼¹çª—()">å…³é—­</button>
            </div>
        </div>
    </div>

    <input type="file" id="éšè—ä¸Šä¼ " style="display:none" accept="image/*">

    <script>
        const BIN_ID = '694684fbd0ea881f40360d96';
        const API_KEY = '$2a$10$HCO6T/SodpbU9GwiCzOV2uvw75u5tfxjQ5vdK3rvhmJiWdFsUxqTu';
        const IMG_BB_KEY = '192ec7a9ecdec9b51ffed683da3842dc';
        const å¯†ç  = 'YXC233';

        let å†…å­˜æ•°æ® = [];
        let å½“å‰ç¼–è¾‘ç´¢å¼• = -1;
        let æ˜¯å¦ç¼–è¾‘æ¨¡å¼ = false; // é»˜è®¤ä¸ºè§‚å¯Ÿæ¨¡å¼
        let æœ‰æœªä¿å­˜å˜æ›´ = false;

        window.onload = function() {
            åŠ è½½æ•°æ®();
            åˆå§‹åŒ–å¥¥æœ¯å°˜åŸƒ();
        };

        // --- æ ¸å¿ƒçŠ¶æ€æ§åˆ¶ ---

        function åˆ‡æ¢æ¨¡å¼() {
            if (!æ˜¯å¦ç¼–è¾‘æ¨¡å¼) {
                // å½“å‰æ˜¯è§‚å¯Ÿæ¨¡å¼ï¼Œå°è¯•è¿›å…¥ç¼–è¾‘æ¨¡å¼
                const p = prompt("è¯·è¾“å…¥ç‘Ÿå¸Œéš†å¯†è¯­ä»¥è§£é™¤å°å°:");
                if (p === å¯†ç ) {
                    æ˜¯å¦ç¼–è¾‘æ¨¡å¼ = true;
                    document.body.classList.add('ç¼–è¾‘æ¨¡å¼');
                    // ä¿®å¤ç‚¹ï¼šè¿›å…¥ç¼–è¾‘æ¨¡å¼åï¼ŒæŒ‰é’®å˜ä¸ºâ€œğŸ‘ è§‚å¯Ÿæ¨¡å¼â€ï¼Œæç¤ºç‚¹å‡»å¯é€€å›è§‚å¯Ÿ
                    document.getElementById('æ¨¡å¼æŒ‰é’®').innerHTML = "ğŸ‘ è§‚å¯Ÿæ¨¡å¼";
                    æ›´æ–°çŠ¶æ€("æƒé™å·²è§£é”ã€‚");
                    æ¸²æŸ“è¡¨æ ¼();
                } else {
                    alert("ç§˜è¯­é”™è¯¯ï¼");
                }
            } else {
                // å½“å‰æ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œå°è¯•é€€å‡ºåˆ°è§‚å¯Ÿæ¨¡å¼
                if (æœ‰æœªä¿å­˜å˜æ›´) {
                    if(!confirm("æœ‰æœªä¿å­˜çš„å˜æ›´ï¼Œé€€å‡ºå°†å¯¼è‡´æ•°æ®ä¸¢å¤±ï¼ˆé™¤éæ‰‹åŠ¨åŒæ­¥ï¼‰ï¼Œç¡®å®šé€€å‡ºå—ï¼Ÿ")) return;
                }
                æ˜¯å¦ç¼–è¾‘æ¨¡å¼ = false;
                document.body.classList.remove('ç¼–è¾‘æ¨¡å¼');
                // ä¿®å¤ç‚¹ï¼šé€€å‡ºç¼–è¾‘æ¨¡å¼åï¼ŒæŒ‰é’®å˜å›â€œâœ ç¼–è¾‘æ¨¡å¼â€
                document.getElementById('æ¨¡å¼æŒ‰é’®').innerHTML = "âœ ç¼–è¾‘æ¨¡å¼";
                æ›´æ–°çŠ¶æ€("å›å½’è§‚å¯Ÿè€…è§†è§’ã€‚");
                æ¸²æŸ“è¡¨æ ¼();
            }
        }

        function è®¾ç½®æœªä¿å­˜çŠ¶æ€(çŠ¶æ€) {
            æœ‰æœªä¿å­˜å˜æ›´ = çŠ¶æ€;
            const btn = document.getElementById('ä¿å­˜æŒ‰é’®');
            if (çŠ¶æ€) {
                btn.classList.add('æŒ‰é’®-æœªä¿å­˜');
                btn.innerHTML = "âš  å˜æ›´æœªä¿å­˜";
                document.title = "* æœªä¿å­˜ - ç¬¦æ–‡é¢†ä¸»çš„å´›èµ·";
                saveLocal(); // åŒæ—¶ä¹Ÿå­˜ä¸€ä»½åˆ°æœ¬åœ°ç¼“å­˜
            } else {
                btn.classList.remove('æŒ‰é’®-æœªä¿å­˜');
                btn.innerHTML = "â— ç¥­ä»ªä¿å­˜ (åŒæ­¥)";
                document.title = "ç¬¦æ–‡é¢†ä¸»çš„å´›èµ· - NPC åŠ¨æ€æ¡£æ¡ˆåº“";
            }
        }

        // é˜²æ­¢è¯¯å…³é—­
        window.onbeforeunload = function(e) {
            if (æœ‰æœªä¿å­˜å˜æ›´) {
                e.preventDefault();
                e.returnValue = '';
                return 'ä¾¦æµ‹åˆ°æœªä¿å­˜çš„é­”æ³•æ³¢åŠ¨ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
            }
        };

        // --- æ•°æ®é€»è¾‘ ---

        async function åŠ è½½æ•°æ®() {
            æ›´æ–°çŠ¶æ€("æ­£åœ¨ç¿»é˜…é‡‘åº“è´¦æœ¬...");
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                    headers: { 'X-Master-Key': API_KEY, 'X-Bin-Meta': false }
                });
                const data = await res.json();
                å†…å­˜æ•°æ® = Array.isArray(data) ? data : (data.record || []);
                æ¸²æŸ“è¡¨æ ¼();
                è®¾ç½®æœªä¿å­˜çŠ¶æ€(false);
                æ›´æ–°çŠ¶æ€("æ¡£æ¡ˆå·²è½½å…¥ã€‚æ„¿é˜¿å·´è¾¾å°”æŒ‡å¼•ä½ ã€‚");
            } catch (e) {
                æ›´æ–°çŠ¶æ€("åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚");
            }
        }

        function æ¸²æŸ“è¡¨æ ¼() {
            const tbody = document.getElementById("è¡¨æ ¼ä¸»ä½“");
            tbody.innerHTML = '';
            
            // æ ¹æ®æ¨¡å¼å†³å®šæ˜¯å¦å¼€å¯ contenteditable
            const editableAttr = æ˜¯å¦ç¼–è¾‘æ¨¡å¼ ? 'contenteditable="true"' : '';

            å†…å­˜æ•°æ®.forEach((npc, index) => {
                const tr = document.createElement('tr');
                tr.className = 'è¡Œè¿›å…¥';
                tr.style.animationDelay = `${index * 0.05}s`;
                
                let html = `
                    <td>
                        <div class="ç«‹ç»˜æ¡†" onclick="é¢„è§ˆå›¾ç‰‡('${npc.ç«‹ç»˜}')">
                            <img src="${npc.ç«‹ç»˜}" class="äººç‰©å›¾">
                        </div>
                    </td>
                    <td ${editableAttr} onblur="åŒæ­¥å†…å­˜(${index}, 'å§“å', this.innerText)" class="å§“åæ ¼">${npc.å§“å}</td>
                    <td ${editableAttr} onblur="åŒæ­¥å†…å­˜(${index}, 'èŒä½', this.innerText)">${npc.èŒä½}</td>
                    <td ${editableAttr} onblur="åŒæ­¥å†…å­˜(${index}, 'åŠ¨æœº', this.innerText)">${npc.åŠ¨æœº}</td>
                    <td ${editableAttr} onblur="åŒæ­¥å†…å­˜(${index}, 'å¤‡æ³¨', this.innerText)">${npc.å¤‡æ³¨}</td>
                `;

                // ç®¡ç†åˆ— (å†…å®¹ç”± CSS æ§åˆ¶æ˜¾ç¤º/éšè—ï¼Œä½† HTML ç»“æ„éœ€è¦å­˜åœ¨)
                html += `
                    <td class="ç®¡ç†åˆ—">
                        <div class="ç®¡ç†æ ¼">
                            <div class="æ’åºæ§ä»¶">
                                <button class="å°æ–¹é’®" onclick="ç§»åŠ¨ä½æ¬¡(${index}, -1)">â–²</button>
                                <button class="å°æ–¹é’®" onclick="ç§»åŠ¨ä½æ¬¡(${index}, 1)">â–¼</button>
                            </div>
                            <div class="æ“ä½œç»„">
                                <button class="æŒ‰é’®" style="padding:2px 6px; font-size:11px; flex:1;" onclick="æ‰“å¼€æ›´å›¾å¼¹çª—(${index})">æ›´å›¾</button>
                                <button class="æŒ‰é’®" style="padding:2px 6px; font-size:11px; background:#444; flex:1;" onclick="åˆ é™¤NPC(${index})">æŠ¹é™¤</button>
                            </div>
                        </div>
                    </td>
                `;

                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
        }

        function åŒæ­¥å†…å­˜(idx, key, val) {
            const cleanVal = val.trim();
            if (å†…å­˜æ•°æ®[idx][key] !== cleanVal) {
                å†…å­˜æ•°æ®[idx][key] = cleanVal;
                è®¾ç½®æœªä¿å­˜çŠ¶æ€(true);
            }
        }

        function æ·»åŠ è¡Œ() {
            å†…å­˜æ•°æ®.push({ 
                ç«‹ç»˜: 'https://via.placeholder.com/65x80/8b0000/ffffff?text=?', 
                å§“å: 'æ–°NPC', èŒä½: 'æ–°èŒä½', åŠ¨æœº: 'åŠ¨æœº', å¤‡æ³¨: 'è®°å½•...' 
            });
            æ¸²æŸ“è¡¨æ ¼();
            è®¾ç½®æœªä¿å­˜çŠ¶æ€(true);
            setTimeout(() => document.getElementById('é¡µå°¾é”šç‚¹').scrollIntoView({ behavior: 'smooth' }), 100);
        }

        function åˆ é™¤NPC(idx) {
            if (confirm(`ç¡®å®šè¦æŠ¹é™¤ã€Œ${å†…å­˜æ•°æ®[idx].å§“å}ã€çš„è®°å½•å—ï¼Ÿ`)) {
                å†…å­˜æ•°æ®.splice(idx, 1);
                æ¸²æŸ“è¡¨æ ¼();
                è®¾ç½®æœªä¿å­˜çŠ¶æ€(true);
            }
        }

        function ç§»åŠ¨ä½æ¬¡(index, step) {
            const newIndex = index + step;
            if (newIndex >= 0 && newIndex < å†…å­˜æ•°æ®.length) {
                const temp = å†…å­˜æ•°æ®[index];
                å†…å­˜æ•°æ®[index] = å†…å­˜æ•°æ®[newIndex];
                å†…å­˜æ•°æ®[newIndex] = temp;
                æ¸²æŸ“è¡¨æ ¼();
                è®¾ç½®æœªä¿å­˜çŠ¶æ€(true);
            }
        }

        async function ä¿å­˜åˆ°äº‘ç«¯() {
            // ä¿å­˜æ—¶äºŒæ¬¡éªŒè¯ï¼Œé˜²æ­¢è¯¯æ“ä½œ
            const p = prompt("ç¡®è®¤è¦å°†æ›´æ”¹åˆ»å…¥åœ£ç‰©å—ï¼Ÿ(è¾“å…¥å¯†è¯­):");
            if (p !== å¯†ç ) { alert("å¯†è¯­é”™è¯¯ã€‚"); return; }

            æ›´æ–°çŠ¶æ€("æ­£åœ¨å°å­˜å·è½´...");
            try {
                await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                    body: JSON.stringify(å†…å­˜æ•°æ®)
                });
                è®¾ç½®æœªä¿å­˜çŠ¶æ€(false);
                æ›´æ–°çŠ¶æ€("ä¿å­˜æˆåŠŸï¼æ¡£æ¡ˆå·²å®‰å…¨è¿›å…¥é‡‘åº“ã€‚");
            } catch (e) {
                æ›´æ–°çŠ¶æ€("ä¿å­˜å¤±è´¥ã€‚");
                alert("äº‘ç«¯åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚");
            }
        }

        // --- å›¾ç‰‡å¤„ç† ---

        function æ‰“å¼€æ›´å›¾å¼¹çª—(index) {
            å½“å‰ç¼–è¾‘ç´¢å¼• = index;
            document.getElementById('æ›´å›¾å¼¹çª—').style.display = 'flex';
            document.getElementById('ç½‘å€è¾“å…¥æ¡†').value = '';
        }

        function å…³é—­æ›´å›¾å¼¹çª—() {
            document.getElementById('æ›´å›¾å¼¹çª—').style.display = 'none';
        }

        async function æ‰§è¡Œä¸Šä¼ (file) {
            if (!file) return;
            æ›´æ–°çŠ¶æ€("æ­£åœ¨å‘ä½é¢æ¢çº½ä¼ è¾“å›¾åƒ...");
            å…³é—­æ›´å›¾å¼¹çª—();
            const formData = new FormData();
            formData.append("image", file);
            try {
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMG_BB_KEY}`, {
                    method: "POST", body: formData
                });
                const result = await res.json();
                if (result.success) {
                    å†…å­˜æ•°æ®[å½“å‰ç¼–è¾‘ç´¢å¼•].ç«‹ç»˜ = result.data.url;
                    æ¸²æŸ“è¡¨æ ¼();
                    è®¾ç½®æœªä¿å­˜çŠ¶æ€(true);
                    æ›´æ–°çŠ¶æ€("ç«‹ç»˜æ›´æ›¿æˆåŠŸã€‚");
                }
            } catch (err) { alert("ä¼ è¾“å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚"); }
        }

        function ç¡®å®šç½‘å€() {
            const url = document.getElementById('ç½‘å€è¾“å…¥æ¡†').value.trim();
            if (url) {
                å†…å­˜æ•°æ®[å½“å‰ç¼–è¾‘ç´¢å¼•].ç«‹ç»˜ = url;
                æ¸²æŸ“è¡¨æ ¼();
                è®¾ç½®æœªä¿å­˜çŠ¶æ€(true);
                å…³é—­æ›´å›¾å¼¹çª—();
                æ›´æ–°çŠ¶æ€("å·²é“¾æ¥å¤–éƒ¨å¹»å½±å›¾ã€‚");
            }
        }

        document.getElementById('éšè—ä¸Šä¼ ').onchange = (e) => {
            æ‰§è¡Œä¸Šä¼ (e.target.files[0]);
        };

        // --- æ‚é¡¹ä¸ç‰¹æ•ˆ ---

        function åˆå§‹åŒ–å¥¥æœ¯å°˜åŸƒ() {
            const å®¹å™¨ = document.getElementById('ç‰¹æ•ˆå±‚');
            for (let i = 0; i < 40; i++) {
                åˆ›å»ºç²’å­(å®¹å™¨);
            }
        }

        function åˆ›å»ºç²’å­(å®¹å™¨) {
            const ç²’å­ = document.createElement('div');
            ç²’å­.classList.add('å¥¥æœ¯å°˜åŸƒ');
            const size = Math.random() * 3 + 1;
            ç²’å­.style.width = `${size}px`; ç²’å­.style.height = `${size}px`;
            ç²’å­.style.left = `${Math.random() * 100}%`;
            const duration = Math.random() * 15 + 10;
            const delay = Math.random() * 10;
            ç²’å­.style.animation = `å°˜åŸƒæ¼‚æµ® ${duration}s linear ${delay}s infinite`;
            å®¹å™¨.appendChild(ç²’å­);
        }

        document.addEventListener('paste', function(e) {
            if (document.getElementById('æ›´å›¾å¼¹çª—').style.display === 'flex') {
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (let item of items) {
                    if (item.type.indexOf("image") !== -1) {
                        æ‰§è¡Œä¸Šä¼ (item.getAsFile());
                    }
                }
            }
            if (e.target.getAttribute('contenteditable')) {
                e.preventDefault();
                const text = (e.originalEvent || e).clipboardData.getData('text/plain');
                document.execCommand('insertText', false, text);
            }
        });

        function saveLocal() {
            localStorage.setItem('pf_rotr_local', JSON.stringify(å†…å­˜æ•°æ®));
        }

        function å¯¼å‡ºå¤‡ä»½() {
            const blob = new Blob([JSON.stringify(å†…å­˜æ•°æ®, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `NPCå¤‡ä»½_${new Date().toLocaleDateString()}.json`;
            a.click();
        }

        function è§¦å‘å¯¼å…¥() { document.getElementById("å¯¼å…¥æ¡†").click(); }

        function å¯¼å…¥å¤‡ä»½(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                å†…å­˜æ•°æ® = JSON.parse(ev.target.result);
                æ¸²æŸ“è¡¨æ ¼();
                è®¾ç½®æœªä¿å­˜çŠ¶æ€(true);
                æ›´æ–°çŠ¶æ€("å¤‡ä»½å·²è½½å…¥ï¼Œç‚¹å‡»åŒæ­¥ç”Ÿæ•ˆã€‚");
            };
            reader.readAsText(file);
        }

        function é¢„è§ˆå›¾ç‰‡(s) {
            document.getElementById("é¢„è§ˆå›¾").src = s;
            document.getElementById("æ”¾å¤§é¢„è§ˆ").style.display = 'flex';
        }

        function æ›´æ–°çŠ¶æ€(s) { 
            const el = document.getElementById("çŠ¶æ€æ ");
            el.style.opacity = 0;
            setTimeout(() => { el.innerText = s; el.style.opacity = 1; }, 200);
        }
    </script>
</body>
</html>